var ISODate={convert:function(a){if("string"!==typeof a)throw"ISODate, convert: input must be a string";a=a.match(/^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2}):(\d{2}(?:\.\d+)?)(Z|(([+-])(\d{2}):(\d{2})))$/i);if(!a)throw"ISODate, convert: Illegal format";return new Date(Date.UTC(a[1],a[2]-1,a[3],a[4],a[5],a[6]|0,1E3*a[6]-1E3*(a[6]|0)|0,a[7])+("Z"===a[7].toUpperCase()?0:(3600*a[10]+60*a[11])*("-"===a[9]?1E3:-1E3)))},format:function(a,b){"string"===typeof a&&(a=this.convert(a));if(!(a instanceof Date))throw"ISODate, format: t is not a date object";
a=b?[a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds()]:[a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds()];return this.month[a[1]]+" "+this.ordinal(a[2])+", "+a[0]+" @ "+this.clock12(a[3],a[4])}};String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")};String.prototype.startsWith=function(a){return this.match("^"+a)==a};
String.prototype.endsWith=function(a){return this.match(a+"$")==a};function isArray(a){return a&&!a.propertyIsEnumerable("length")&&"object"===typeof a&&"number"===typeof a.length}function convertIsoDate(a,b){var c="";try{c=ISODate.convert(a).format(b)}catch(d){c="Could not parse date: "+a}return c}var Serendip=function(){};Serendip.Class=function(){$.extend(this,Simple.Events)};Serendip.Class.extend=function(a){var b=this,c=function(c){Serendip.extend(this,new b(c),a,c)};c.extend=this.extend;return c};
Serendip.extend=function(){for(var a=arguments[0]||{},b=1,c=arguments.length,d;b<c;b++)if(null!=(d=arguments[b]))for(var e in d){var g=a[e],f=d[e];a!==f&&(f&&"object"==typeof f&&!f.nodeType?a[e]=Serendip.extend(g||(null!=f.length?[]:{}),f):void 0!==f&&(a[e]=f))}return a};
Serendip.Core=Serendip.Class.extend({search:null,getParamsAsQueryString:function(a){for(var b="",c=0;c<a.length;c++)b+=a[c],c<a.length-1&&(b+="&");return b},parseParam:function(a,b){var c=a.indexOf(b);if(-1!=c){var d=a.indexOf("&",c);-1==d&&(d=a.length);return a.substring(c+b.length,d)}return""},parseQueryToMap:function(a,b){for(var c=a.split("&"),d=[],e=0;e<c.length;e++){var g=c[e].split("=");d[g[0]+b]=g[1]}c=a.replace("!/","").split("/");for(e=0;e<c.length-1;e+=2)d[c[e]+b]=c[e+1];return d},isArray:function(a){return a.constructor==
Array}});Serendip.SortField=Serendip.Class.extend({name:null,header:null});Serendip.Term=Serendip.Class.extend({value:null,count:null});Serendip.Facets=Serendip.Class.extend({activeFacetQueries:{},facetIdToFacetMap:null,facets:null,serendip:null,getActiveFacetsQueriesMap:function(){return this.activeFacetQueries},getActiveFacetsMap:function(){return this.facetIdToFacetMap},init:function(a){var b=this;this.facets=a.facets;this.serendip=a;this.facetIdToFacetMap=[];for(var c in this.facets)a=this.facets[c],this.facetIdToFacetMap[a.id]=a;this.serendip.on("views.init.done",function(){b.serendip.trigger("init.facets.core",b)});this.serendip.on("initFromQueryStr",
function(a,c){b.activeFacetQueries={};for(var g=0;g<b.facets.length;g++){var f=b.facets[g],h=f.id+"_param";c[h]&&(h=c[h],facetQuery={},facetQuery.id=f.id,facetQuery.values=h.split(","),b.activeFacetQueries[f.id]=facetQuery)}});this.serendip.on("saveInQueryStr",function(a){for(var c in b.activeFacetQueries){var g=b.activeFacetQueries[c].values;g&&0<g.length&&a(c,g.join(","),6)}});this.serendip.on("buildRequest",function(a){var c=b.getFacetsAsQueryString(b.facets);a("&facet=true&"+c);c=b.getActiveFacetsQuery();
a("&"+c)});this.serendip.on("facet.remove",function(a){b.handleFacetClick(a.id,a.value,!1)});this.serendip.on("facet.add",function(a){b.handleFacetClick(a.id,a.value,!0)})},getActiveFacetsQuery:function(){var a=[],b;for(b in this.activeFacetQueries){var c=this.facetIdToFacetMap[b],d=this.activeFacetQueries[b];0<d.values.length&&(c=c.getActiveQuery(d.values),a.push(c))}return 0<a.length?"&"+a.join("&"):""},getFacetsAsQueryString:function(a){for(var b="",c=0;c<a.length;c++)b+=a[c].getQuery(),c<a.length-
1&&(b+="&");return b},handleFacetClick:function(a,b,c){var b=decodeURIComponent(b),d=this.facetIdToFacetMap[a],e=this.activeFacetQueries[a];e||(e={},e.id=d.id,e.values=[]);if(c)e.values.push(b);else{c=[];for(d=0;d<e.values.length;d++)e.values[d]!=b&&c.push(e.values[d]);e.values=c}this.activeFacetQueries[a]=e}});Serendip.Facet=Serendip.Class.extend({facetType:"text",name:null,activeHeader:null,header:null,minFacetsToDisplay:null,maxFacetsToDisplay:null,facets:[],addSubFacet:function(a){this.facets.push(a)},getActiveQuery:function(a){var b="fq={!tag="+this.id+"}"+this.name,a=this.getActiveQueryValues(a);return b+(":("+a+")")},getActiveQueryValues:function(a){for(var b="",c=0;c<a.length;c++)var d=encodeURIComponent(a[c]),b=b+this.getActiveQueryValue(d);return b},getActiveQueryValue:function(a){return'"'+a+
'" '},getQuery:function(){return"facet.field={!ex="+this.id+"}"+this.name},process:function(a){a=a.facet_counts.facet_fields[this.name];return typeof("undefined"!=a)?a:[]},processActive:function(a){var b=encodeURIComponent(a),a=this.getFormattedValue(a);return this.processActiveField(b,a)},processActiveField:function(a,b){return{header:this.activeHeader,name:this.id,value:a,displayValue:b,isActive:"true"}},getFacetValue:function(a){return a},getFormattedValue:function(a){return a}});Serendip.DateFacet=Serendip.Facet.extend({facetType:"date",dateStart:null,dateEnd:null,dateGap:null,dateFormat:null,sortDir:"asc",getQuery:function(){var a="facet.date={!ex="+this.id+"}"+this.name,b="&f."+this.name+".facet.date",a=a+(b+".start="+encodeURIComponent(this.dateStart)),a=a+(b+".end="+encodeURIComponent(this.dateEnd));return a+=b+".gap="+encodeURIComponent(this.dateGap)},getActiveQueryValue:function(a){return"["+a+"] "},getFacetValue:function(a){return a.from+" TO "+a.to},getFormattedValue:function(a){var b=
convertIsoDate(a.from,this.dateFormat),a=convertIsoDate(a.to,this.dateFormat);return b+" - "+a},processActive:function(a){var b=a.split(" TO "),b=this.getFormattedValue({from:b[0],to:b[1]}),a=encodeURIComponent(a);return this.processActiveField(a,b)},process:function(a){var a=a.facet_counts.facet_dates[this.name],b=[],c;for(c in a)"gap"!=c&&"end"!=c&&(b.push(c),b.push(a[c]));c=[];if("asc"==this.sortDir)for(var d=0;d<b.length;d+=2)this.processDateFacetValue(b,d,c,a,"asc");else for(d=b.length-2;-1<
d;d-=2)this.processDateFacetValue(b,d,c,a,"desc");return c},processDateFacetValue:function(a,b,c,d,e){var g=a[b+1],f={};f.from=a[b];d=this.getGapAsDays(d.gap);d=this.formatIsoDateWithGap(f.from,d);f.to="asc"==e?b+2<a.length?a[b+2]:d:d;c.push(f);c.push(g)},formatIsoDateWithGap:function(a,b){var c="";try{var d=ISODate.convert(a);d.setDate(d.getDate()+b);c=d.format("isoDateTime")+"Z"}catch(e){c="Could not parse date: "+a}return c},convertIsoDate:function(a,b){var c="";try{c=ISODate.convert(a).format(b)}catch(d){c=
"Could not parse date: "+a}return c},getGapAsDays:function(a){var b=1,c=1,d=0;"-"==a[0]&&(b=-1);a.match("YEARS")&&(d=a.substring(1,a.length-5),c=365);a.match("MONTHS")&&(d=a.substring(1,a.length-6),c=30);a.match("DAYS")&&(d=a.substring(1,a.length-4));a.match("YEAR")&&(d=a.substring(1,a.length-4),c=365);a.match("MONTH")&&(d=a.substring(1,a.length-5),c=30);a.match("DAY")&&(d=a.substring(1,a.length-3));d=parseInt(d);return d*b*c}});Serendip.RangeFacet=Serendip.Facet.extend({facetType:"range",rangeStart:null,rangeEnd:null,rangeGap:null,getQuery:function(){var a="facet.range={!ex="+this.id+"}"+this.name,b="&f."+this.name+".facet.range",a=a+(b+".start="+encodeURIComponent(this.rangeStart)),a=a+(b+".end="+encodeURIComponent(this.rangeEnd));return a+=b+".gap="+encodeURIComponent(this.rangeGap)},getActiveQueryValue:function(a){return"["+a+"] "},getFacetValue:function(a){return a.from+" TO "+a.to},getFormattedValue:function(a){return a.from+
" - "+a.to},processActive:function(a){var b=a.split(" TO "),b=this.getFormattedValue({from:b[0],to:b[1]}),a=encodeURIComponent(a);return this.processActiveField(a,b)},process:function(a){for(var b=a.facet_counts.facet_ranges,a=b[this.name].counts,b=b[this.name].gap,c=[],d=0;d<a.length;d+=2){var e=parseInt(a[d]),g=a[d+1],f={from:e};f.to=e+b-1;c.push(f);c.push(g)}return c}});Serendip.QueryFacet=Serendip.Facet.extend({facetType:"query",queries:[],addQuery:function(a){this.queries.push(a)},getQuery:function(){for(var a="",b=this.queries.length,c=0;c<b;c++)a+="facet.query={!ex="+this.id+" key="+this.id+"range["+c+"]}"+this.name+":"+this.queries[c].query,c<b-1&&(a+="&");return a},getFacetValue:function(a){return a.value},getFormattedValue:function(a){return a.formattedValue},getActiveQueryValues:function(a){return a[a.length-1]},process:function(a){for(var a=a.facet_counts.facet_queries,
b=[],c=0;c<this.queries.length;c++){var d=this.queries[c],e=a[this.id+"range["+c+"]"];b.push({formattedValue:d.header,value:d.query});b.push(e)}return b},processActive:function(a){var b=a,c;for(c in this.queries){var d=this.queries[c];d.query==a&&(b=d.header)}a=encodeURIComponent(a);return this.processActiveField(a,b)}});Serendip.FacetsRenderInactive=Serendip.Class.extend({configuredFacets:null,serendip:null,facetCore:null,init:function(a){var b=this;this.serendip=a;this.configuredFacets=a.facets;this.serendip.on("init.facets.core",function(a){b.facetsCore=a});a.on("render",function(c){var c=b.processFacets(c),d=b.getOnlyVisibleFacetRowValues(c);a.trigger("render.facets.inactive",c,d)})},processFacets:function(a){var b=[];if("undefined"!=typeof a.facet_counts)for(var c=this.getValidFacets(this.configuredFacets),d=
0;d<c.length;d++){var e=this.processFacetTypes(a,c[d]);""!=e&&b.push(e)}return b},getValidFacets:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];this.isParentActive(a,d)&&b.push(d)}return b},isParentActive:function(a,b){for(var c=this.getParents(a,b),d=this.facetsCore.getActiveFacetsQueriesMap(),e=0;e<c.length;e++){var g=c[e],f;for(f in d)if(f==g.id)return!0}return 0==c.length?!0:!1},getParents:function(a,b){for(var c=[],d=0;d<a.length;d++){for(var e=a[d],g=0;g<e.facets.length;g++)if(e.facets[g].id==
b.id){c.push(e);break}e=this.getParents(e.facets,b);for(g=0;g<e.length;g++)c.push(e[g])}return c},processFacetTypes:function(a,b){var c=b.process(a);return c?this.processFacet(a,b,c):""},processFacet:function(a,b,c){for(var d=[],c=this.removeEmptyFacets(c),e=c.length,g=0;g<e;g+=2){var f=c[g],h=c[g+1];if(""!=f){var j=this.isFacetFieldActive(a,b,f),f=this.processFacetField(b,f,h,j);""!=f&&d.push(f)}}return{facet:b,values:d}},addMoreFacets:function(a,b,c,d,e,g){e<d&&(d=e);for(var e=[],f={count:0,data:""},
g=g+2;g<d;g+=2){var h=c[g],j=c[g+1],k=this.isFacetFieldActive(a,b,h),h=this.processFacetField(b,h,j,k);""!=h&&(e.push(h),f.count++)}0<f.count&&(f.data=e);return f},removeEmptyFacets:function(a){for(var b=[],c=0;c<a.length;c+=2){var d=a[c],e=a[c+1];if(0<e||-1==e)b.push(d),b.push(e)}return b},processFacetField:function(a,b,c,d){var e=a.getFormattedValue(b),b=a.getFacetValue(b),b=encodeURIComponent(b);return this.processFacetFieldValue(a,b,e,c,d)},isFacetFieldActive:function(a,b,c){if(a=a.responseHeader.params.fq)if(!isArray(a)||
1==a[0].length){if(this.isFacetMatch(a,b,c))return!0}else for(var d=0;d<a.length;d++)if(this.isFacetMatch(a[d],b,c))return!0;return!1},isFacetMatch:function(a,b,c){var d="",d="{!tag="+b.id+"}"+b.name+":(",e=a.substring(0,d.length);if(d!=e)return!1;d=a.substring(d.length,a.length-1);if("text"==b.facetType){b=d.split(/\"\s/);for(a=0;a<b.length;a++)if(e=b[a].replace(/\"/g,"").trim(),e==c)return!0}else if("query"==b.facetType){if(c.value==d)return!0}else if("date"==b.facetType||"customdate"==b.facetType){b=
d.split("]");for(a=0;a<b.length;a++)if(e=b[a].replace(/\[/g,""),e=e.replace(/]/g,"").trim(),0<e.length&&(d=c.from+" TO "+c.to,e==d))return!0}return!1},processFacetFieldValue:function(a,b,c,d,e){return e?"":{name:a.id,value:b,displayValue:c,countValue:d,countValueCls:"count"+d,isActive:"false"}},getOnlyVisibleFacetRowValues:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=this.getVisibleFacetRowValues(d.facet,d.values);b.push({facet:d.facet,values:e})}return b},getVisibleFacetRowValues:function(a,
b){for(var c=[],d=Math.min(a.minFacetsToDisplay,b.length),e=0;e<d;e++)c.push(b[e]);return c}});Serendip.FacetsRenderActive=Serendip.Class.extend({serendip:null,facetsCore:null,init:function(a){var b=this;this.serendip=a;this.serendip.on("init.facets.core",function(a){b.facetsCore=a});this.serendip.on("render",function(){var a=b.createActiveFacets();b.serendip.trigger("render.facets.active",a)})},createActiveFacets:function(){var a=[],b=this.facetsCore.getActiveFacetsQueriesMap(),c=this.facetsCore.getActiveFacetsMap(),d;for(d in b){var e=b[d],g=c[d];if(0!=e.values.length)for(var f=0;f<e.values.length;f++){var h=
g.processActive(e.values[f]);a.push(h)}}return a}});Serendip.Ajax=Serendip.Class.extend({get:function(a,b,c){$.ajax({scriptCharset:"utf-8",type:"GET",url:a,data:"",dataType:"json",contentType:"text/plain; charset=utf-8",timeout:5E3,success:b,error:function(a,b,g){b=!1;try{-1<g.indexOf("<html")&&(b=!0)}catch(f){console&&console.log(f.toSource())}a=jQuery.parseJSON(a.responseText);console&&(console.log(a),console.log(g.toSource()));""==a&&(a="Unable to contact server.");c(a,b)}})}});
Serendip.Core=Serendip.Class.extend({fieldConfig:[],fields:[],facets:[],highlightFields:[],queryParams:[],core:new Serendip.Core({}),searchAllFields:!1,sortQuery:"",clickType:"",cplIndex:-1,solrUrl:"",views:[],facetCore:null,init:function(a){var b=this;this.facetCore.init(this);this.facetRenderActive.init(this);this.facetRenderInactive.init(this);this.fieldConfig.sort(function(a,b){var c=a.header.toLowerCase(),f=b.header.toLowerCase();return c<f?-1:c>f?1:0});this.updateFieldsQueryString();for(var c in this.views)this.views[c].init(this);
this.trigger("views.init.done");$.historyInit(function(a){b.pageload(a)},a)},pageload:function(a){a||(a=window.location.search);0<a.length&&this.initFromQueryStr(a)},addFacet:function(a){this.facets.push(a);if(0<a.facets.length)for(var b=0;b<a.facets.length;b++)this.addFacet(a.facets[b])},addFieldConfig:function(a){this.fieldConfig.push(a);this.fields.push(a.name)},setSearchAllFields:function(){this.searchAllFields=!0;this.addQueryParam("fl","*")},updateFieldsQueryString:function(){if(!1==this.searchAllFields){for(var a=
"",b=0;b<this.fields.length;b++)a+=this.fields[b],b!=this.fields.length-1&&(a+=",");this.addQueryParam("fl",a)}},setHighlightFields:function(a){this.addQueryParam("hl.fl",a.join(" "));this.highlightFields=a},addQueryParam:function(a,b){var c=a+"="+b,d=!1,e;for(e in this.queryParams)-1!=this.queryParams[e].indexOf(a)&&(this.queryParams[e]=c,d=!0);d||this.queryParams.push(a+"="+b)},initFromQueryStr:function(a){var a=decodeURIComponent(a),b=this.core.parseQueryToMap(a,"_param");this.trigger("initFromQueryStr",
a,b);this.doRequest(this,!1)},setSolrUrl:function(a){this.solrUrl=a},addView:function(a){this.views.push(a)},saveHistoryItem:function(){var a="",b=[];this.trigger("saveInQueryStr",function(a,c,d){b.push({id:a,value:c,sortIndex:d})});for(var b=b.sort(function(a,b){var c=a.sortIndex,d=b.sortIndex;return c<d?-1:c>d?1:0}),c=0;c<b.length;c++)var d=b[c],a=a+"/"+d.id+"/"+d.value;$.historyLoad("!"+a)},search:function(){this.trigger("search");this.doRequest(this,!0)},doRequest:function(a,b){a.trigger("wait");
b&&a.saveHistoryItem();a.continueRequest(a)},getFullQuery:function(){var a="";this.trigger("buildRequest",function(b){a+=b});var b=this.core.getParamsAsQueryString(this.queryParams),b=this.solrUrl+"?"+b;return b+(a+"&wt=json")},continueRequest:function(a){var b=a.getFullQuery();ajax.get(b,function(b){null==b&&redirectToLogin();a.trigger("renderStart");a.trigger("render",b);a.trigger("renderFinished")},function(a,b){alert(a);b&&redirectToLogin()})}});
var ajax=new Serendip.Ajax({}),serendip=new Serendip.Core({ajax:ajax,facetCore:new Serendip.Facets({}),facetRenderActive:new Serendip.FacetsRenderActive({}),facetRenderInactive:new Serendip.FacetsRenderInactive({})});serendip.on("render.view",function(a,b,c){b=b.clone();b=b.find(".Placeholder").autoRender(c);c=b.html();a.html(c)});Serendip.FacetsView=Serendip.Class.extend({serendip:null,view:null,prototypes:null,maxFacetsToDisplay:0,activeFacetsView:null,inactiveFacetsView:null,init:function(a){var b=this;this.serendip=a;this.view.hide();var a=this.view.find("#ActiveFacets_Theme"),c=this.prototypes.find("#ActiveFacets_Prototype");this.activeFacetsView=new Serendip.ActiveFacetsView({configuredFacets:this.serendip.facets,view:a,prototype:c,maxFacetsToDisplay:5});this.activeFacetsView.init(this.serendip);a=this.view.find("#InactiveFacets_Theme");
c=this.prototypes.find("#FacetRow_Prototype");this.inactiveFacetsView=new Serendip.InactiveFacetsView({configuredFacets:this.serendip.facets,view:a,prototype:c,maxFacetsToDisplay:5});this.inactiveFacetsView.init(this.serendip);this.serendip.on("render",function(a){b.render(a)})},render:function(a){"undefined"!=typeof a.facet_counts&&this.view.fadeIn("slow")}});Serendip.ActiveFacetsView=Serendip.Class.extend({configuredFacets:null,view:null,prototype:null,serendip:null,inactiveElement:null,init:function(a){var b=this;this.serendip=a;this.inactiveElement=this.view.find(".inactive");this.inactiveElement.hide();this.serendip.on("render.facets.active",function(a){b.renderActiveFacets(a);b.bindEvents()})},bindEvents:function(){function a(a){var d=a.attr("facetname"),a=a.attr("facetvalue");b.serendip.trigger("facet.remove",{id:d,value:a});b.serendip.search()}
var b=this;this.view.find("span.remove").off("click").on("click",function(){var b=$(this).parent().find("a");a(b);return!1});this.view.find("a").off("click").on("click",function(){a($(this));return!1})},renderActiveFacets:function(a){this.renderActiveFacet(a);0==a.length&&this.view.html(this.inactiveElement.html())},renderActiveFacet:function(a){a&&0<a.length?this.serendip.trigger("render.view",this.view,this.prototype,{activeFacet:a}):this.view.html("")}});Serendip.InactiveFacetsView=Serendip.Class.extend({configuredFacets:null,serendip:null,view:null,prototype:null,maxFacetsToDisplay:5,showMoreFacetsView:null,init:function(a){var b=this;this.serendip=a;this.showMoreFacetsView=this.createMoreFacetsView();this.serendip.on("render.facets.inactive",function(c,d){var e=b.renderAllFacets(d);b.view.html(e);a.trigger("render.facets.showmore",c);b.bindEvents()})},createMoreFacetsView:function(){var a=new Serendip.ShowMoreFacetsView({view:this.view,prototype:this.prototype});
a.init(this.serendip);return a},bindEvents:function(){var a=this;this.view.find(".facetRow a").off("click").on("click",function(){var b=$(this),c=b.attr("facetname"),d=b.attr("facetvalue");b.attr("active");a.serendip.trigger("facet.add",{id:c,value:d});a.serendip.search();return!1})},renderAllFacets:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],d=this.renderFacet(d.facet,d.values);b.push(d)}return b.join("")},renderFacet:function(a,b){if(""==b)return"";var c={facetName:a.id,facetHeader:a.header},
d={facetRow:b},e=this.prototype.clone(),e=e.find(".Placeholder").autoRender(c);e.find(".FacetValues").autoRender(d);return e.html()}});Serendip.ShowMoreFacetsView=Serendip.Class.extend({view:null,prototype:null,init:function(a){var b=this;a.on("render.facets.showmore",function(a){b.view.find(".lessFacetsTxt").hide();b.renderMoreFacets(a);b.bindEvents()})},renderMoreFacets:function(a){for(var b=0;b<a.length;b++){var c=a[b],d=c.facet,c=this.getShowMoreFacetRowValues(d,c.values);0<c.length?(c=this.renderFacetRow(d,c),this.view.find("."+d.id+" .MoreFacetsValues").html(c).hide()):this.view.find("."+d.id+" .moreFacetsTxt").hide()}},renderFacetRow:function(a,
b){var c={facetRow:b},d=this.prototype.clone().find(".FacetValues"),d=d.autoRender(c);return d.html()},getShowMoreFacetRowValues:function(a,b){for(var c=[],d=a.minFacetsToDisplay,e=Math.min(a.maxFacetsToDisplay+d,b.length);d<e;d++)c.push(b[d]);return c},bindEvents:function(){var a=this;this.view.find("a.moreFacets").off("click").on("click",function(){a.handleShowMoreLess($(this));return!1})},handleShowMoreLess:function(a){var b=a.attr("facetname"),a=this.view.find("."+b+" .MoreFacetsValues"),c=this.view.find("."+
b+" .moreFacetsTxt"),b=this.view.find("."+b+" .lessFacetsTxt");"none"==a.css("display")?(a.slideDown("slow",function(){$(this).show()}),c.hide(),b.show()):(a.slideUp("slow",function(){$(this).hide()}),b.hide(),c.show())}});Serendip.ResultView=Serendip.Class.extend({view:null,prototype:null,serendip:null,init:function(a){var b=this;this.serendip=a;this.serendip.on("render",function(a){b.render(a)})},render:function(a){var b=a.response.docs,c=[];for(i=0;i<b.length;i++){var d=this.processDoc(b[i],a.highlighting);c.push(d)}this.renderDocuments(c)},processDoc:function(a,b){for(var c=this.serendip.fieldConfig,d=this.serendip.fields,e=this.serendip.highlightFields,g={},f=0;f<d.length;f++)g[d[f]]=this.getFieldValue(a,b,d[f]);
for(f=0;f<e.length;f++)g[e[f]]=this.getFieldValue(a,b,e[f]);return this.processDocData(g,d,c)},processDocData:function(a,b,c){var b={},d;for(d in c){var e=c[d],g=this.getParam(a,e.name);if(e.isDate&&g)try{g=ISODate.convert(g).format(e.dateFormat)}catch(f){g="1-01-01T00:00:00Z"==g?"Ingen verdi":"Warning: expected date value, but got: "+g}b[e.id]=g}return b},renderDocuments:function(a){this.serendip.trigger("render.view",this.view,this.prototype,{docs:a})},getFieldValue:function(a,b,c){b="undefined"==
typeof b?a[c]:b[a.id][c];"undefined"==typeof b&&(b=a[c]);return b},getParam:function(a,b,c){a[b]&&(c=a[b]);isArray(c)&&(c=c.join(""));return c}});Serendip.PagerView=Serendip.Class.extend({view:null,prototype:null,windowSize:5,pages:10,resultsPrPage:10,startDoc:0,isTrigger:!1,serendip:null,init:function(a){var b=this;this.serendip=a;this.serendip.on("search",function(){b.isTrigger||(b.startDoc=0)});this.serendip.on("render",function(a){b.render(a)});this.serendip.on("initFromQueryStr",function(a,d){b.startDoc=d.Page_param?(d.Page_param-1)*b.resultsPrPage:0});this.serendip.on("saveInQueryStr",function(a){a("Page",b.startDoc/b.resultsPrPage+1,
2)});this.serendip.on("buildRequest",function(a){a("&start="+b.startDoc)});this.serendip.on("resultsPrPageChanged",function(a){b.resultsPrPage=a})},bindEvents:function(){var a=this;this.view.find("li a").off("click").on("click",function(){var b=$(this).attr("page");a.startDoc=(b-1)*a.resultsPrPage;a.isTrigger=!0;a.serendip.search();return a.isTrigger=!1})},render:function(a){this.startDoc=a.response.start;var a=Math.ceil(a.response.numFound/this.resultsPrPage),b=Math.ceil(this.startDoc/this.resultsPrPage)+
1,c=b-this.windowSize+1,d=b+this.windowSize+1;1>c&&(c=1);d>a&&(d=a+1);var e=d-c;e<this.pages&&(d+=this.pages-e+1);1>c&&(c=1);d>a&&(d=a+1);this.renderPagerImpl(b,a,c,d);this.bindEvents()},renderPagerImpl:function(a,b,c,d){function e(a,b,c,d,e){return{page:a,regularPageActive:b,currentPageActive:c,nextPageActive:d,prevPageActive:e}}var g=[];if(1<a){var f=e(a-1,"inactive","inactive","inactive","active");g.push(f)}for(;c<d;c++){var f="inactive",h="active";c==a&&(f="active",h="inactive");f=e(c,h,f,"inactive",
"inactive");g.push(f)}a<b&&(f=e(a+1,"inactive","inactive","active","inactive"),g.push(f));a={pageRow:g};1<b?this.serendip.trigger("render.view",this.view,this.prototype,a):this.view.html("")}});Serendip.SearchView=Serendip.Class.extend({view:null,serendip:null,input:null,init:function(a){this.serendip=a;var b=this;this.input=this.view.find(".input");this.view.find(".button").click(function(){b.serendip.search(b.input.val());return!1});this.serendip.on("initFromQueryStr",function(a,d){b.input.val(d.query_param)});this.serendip.on("saveInQueryStr",function(a){var d=b.input.val();(d=encodeURIComponent(d))&&""!=d&&a("query",d,1)});this.serendip.on("buildRequest",function(a){var d=b.buildRequest();
a(d)})},buildRequest:function(){var a=this.input.val();if("*"==a[0]||"?"==a[0])a=a.substring(1,a.length),this.input.val(a);""==a&&(a="*:*");return"&q="+encodeURIComponent(a)}});Serendip.SortingView=Serendip.Class.extend({view:null,serendip:null,sortQuery:"",sortValue:"",sortDir:"",sortFields:null,init:function(a){this.serendip=a;var b=this;this.serendip.on("renderFinished",function(){b.renderFinished(b)});this.serendip.on("initFromQueryStr",function(a,d){b.initFromQueryStr(a,d)});this.serendip.on("saveInQueryStr",function(a){b.sortValue&&(b.sortDir&&"relevans"!=b.sortValue)&&(a("SortBy",b.sortValue,5),a("OrderBy",b.sortDir,5))});this.serendip.on("buildRequest",function(a){b.sortValue&&
(b.sortDir&&"relevans"!=b.sortValue)&&a("&sort="+b.sortValue+" "+b.sortDir)})},initFromQueryStr:function(a,b){var c=b.SortBy_param;if(c){var d=b.OrderBy_param;d||(d="asc");this.sortQuery="&sort="+c+" "+d;this.sortValue=c;this.sortDir=d}return a+=this.sortQuery},bindEvents:function(){var a=this;this.view.find("th .sortfield a").off("click").on("click",function(){var b=$(this).attr("sort"),c=$(this).attr("direction"),b=a.GetFieldNameForId(b);a.handleSortClick(b,c);return!1})},renderFinished:function(){var a=
this.GetIdForFieldName(this.sortValue);this.setSortFieldActive(a,this.sortDir);this.bindEvents()},handleSortClick:function(a,b){this.sortQuery=a&&b&&"relevans"!=a?"&sort="+a+" "+b:"";this.sortValue=a;this.sortDir=b;this.serendip.search()},setSortFieldActive:function(a,b){var c=this.GetClassNameForRows(a);this.view.find(".sortfield .active").removeClass("active").addClass("inactive");var c=$("."+c),d=this.ReverseSortDirection(b);c.find(".sortfield ."+b).removeClass(b).addClass(d);c.find(".sortfield .inactive").removeClass("inactive").addClass("active");
c.find(".sortfield a").attr("direction",d)},GetSortField:function(a){return a.split(" ")[0]},GetSortDirection:function(a){var b="asc",a=a.split(" ");0<a.length&&"desc"==a[a.length-1]&&(b="desc");return b},ReverseSortDirection:function(a){return"asc"==a?"desc":"asc"},GetFieldNameForId:function(a){for(var b=serendip.fieldConfig,c=0;c<b.length;c++){var d=b[c];if(d.id==a)return d.name}return""},GetIdForFieldName:function(a){for(var b=serendip.fieldConfig,c=0;c<b.length;c++){var d=b[c];if(d.name==a)return d.id}return""},
GetClassNameForRows:function(a){return a+"Row"}});Serendip.ResultInfoView=Serendip.Class.extend({view:null,prototype:null,serendip:null,init:function(a){var b=this;this.serendip=a;this.serendip.on("render",function(a){b.render(a)})},render:function(a){this.serendip.trigger("render.view",this.view,this.prototype,{numDocs:a.response.numFound,time:a.responseHeader.QTime})}});Serendip.ResultPrPageView=Serendip.Class.extend({view:null,resultsToDisplay:10,serendip:null,init:function(a){var b=this;this.serendip=a;this.view.find("select").change(function(){b.resultsToDisplay=$(this).val();b.serendip.search()});this.serendip.on("render",function(a){b.render(a)});this.serendip.on("initFromQueryStr",function(a,d){d.Results_param&&(b.resultsToDisplay=d.Results_param,b.serendip.trigger("resultsPrPageChanged",b.resultsToDisplay))});this.serendip.on("saveInQueryStr",function(a){a("Results",
b.resultsToDisplay,2)});this.serendip.on("buildRequest",function(a){a("&rows="+b.resultsToDisplay)})},render:function(){this.view.find("select").val(this.resultsToDisplay)}});Serendip.InProgressView=Serendip.Class.extend({view:null,serendip:null,init:function(a){var b=this;this.serendip=a;this.view.hide();this.serendip.on("wait",function(){b.view.show()});this.serendip.on("render",function(){b.view.hide()})}});
