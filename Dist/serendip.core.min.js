var Serendip=function(){};Serendip.Events=function(){var c={},a={};c.on=function(b,d,f){var g=a||(a={});(g[b]||(g[b]=[])).push({callback:d,context:f})};c.off=function(b,d,f){!d&&!f&&delete a[b];for(var b=a[b]||[],g=0;g<b.length;g++)d&&b[g].callback!==d||f&&b[g].context!==f||b.splice(g,1)};c.trigger=function(b){for(var d=Array.prototype.slice.call(arguments,1),f=(a||{})[b]||[],g=0;g<f.length;g++){var e=f[g];e.callback.apply(e.context||c,d)}};return c}();Serendip.Utils=function(){var c={formatISODate:function(a,b){var d="";try{d=c.convertISOFormatToDate(a).format(b)}catch(f){d="Could not parse date: "+a}return d},convertISOFormatToDate:function(a){if("string"!==typeof a)throw"ISODate, convert: input must be a string";a=a.match(/^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2}):(\d{2}(?:\.\d+)?)(Z|(([+-])(\d{2}):(\d{2})))$/i);if(!a)throw"ISODate, convert: Illegal format";return new Date(Date.UTC(a[1],a[2]-1,a[3],a[4],a[5],a[6]|0,1E3*a[6]-1E3*(a[6]|0)|0,
a[7])+("Z"===a[7].toUpperCase()?0:(3600*a[10]+60*a[11])*("-"===a[9]?1E3:-1E3)))},isArray:function(a){return a&&!a.propertyIsEnumerable("length")&&"object"===typeof a&&"number"===typeof a.length},trim:function(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},splitSolrMultiValue:function(a){for(var b=[],a=a.split("]"),d=0;d<a.length;d++){var f=a[d].replace(/\[/g,""),f=f.replace(/]/g,""),f=c.trim(f);0<f.length&&b.push(f)}return b},setupEvents:function(a){a.on=Serendip.Events.on;a.trigger=Serendip.Events.trigger}};
return c}();Serendip.Ajax=function(){return{get:function(c,a,b){$.ajax({scriptCharset:"utf-8",type:"GET",url:c,data:"",dataType:"json",contentType:"text/plain; charset=utf-8",timeout:5E3,success:a,error:function(a,f,g){f=!1;try{-1<g.indexOf("<html")&&(f=!0)}catch(e){console&&console.log(e.toSource())}a=jQuery.parseJSON(a.responseText);console&&(console.log(a),console.log(g.toSource()));""==a&&(a="Unable to contact server.");b(a,f)}})}}}();
Serendip.History=function(){function c(b){b||(b=window.location.search);0<b.length&&a.trigger("history.change",b)}var a={};Serendip.Utils.setupEvents(a);a.init=function(){$.historyInit(c,"index.html")};a.load=function(a){$.historyLoad(a)};return a}();Serendip.Core=function(c,a){function b(){if(!1==_enableAllFields){for(var a=[],d=0;d<h.fieldConfig.length;d++){var b=h.fieldConfig[d];b.isEnabled&&a.push(b.name)}h.removeQueryParam("fl");h.addQueryParam("fl",a.join(","))}}function d(a,d){var b=a.header.toLowerCase(),f=d.header.toLowerCase();return b<f?-1:b>f?1:0}function f(a,d){var b=a.sortIndex,f=d.sortIndex;return b<f?-1:b>f?1:0}function g(a){h.trigger("wait");a&&h.saveHistoryItem();var d="";h.trigger("buildRequest",function(a){d+=a});for(var a=
"",b=0;b<_queryParams.length;b++)a+=_queryParams[b],b<_queryParams.length-1&&(a+="&");a=solrUrl+"?"+a;c.get(a+(d+"&wt=json"),l,e)}function e(a,d){alert(a);d&&redirectToLogin()}function l(a){null==a&&redirectToLogin();h.trigger("renderStart");h.trigger("render",a);h.trigger("renderFinished")}var h={fieldConfig:[],fields:[],facets:[],highlightFields:[]};_queryParams=[];_enableAllFields=!1;clickType=sortQuery="";cplIndex=-1;solrUrl="";Serendip.Utils.setupEvents(h);h.init=function(){h.trigger("views.init");
h.fieldConfig.sort(d);b();h.trigger("views.init.done");a.on("history.change",function(a){for(var d=a=decodeURIComponent(a),b=d.split("&"),f={},e=0;e<b.length;e++){var c=b[e].split("=");f[c[0]]=c[1]}b=d.replace("!/","").split("/");for(e=0;e<b.length-1;e+=2)f[""+b[e]+""]=b[e+1];h.trigger("initFromQueryStr",a,f);g(!1)});a.init()};h.addFacet=function(a){h.facets.push(a);if(0<a.facets.length)for(var d=0;d<a.facets.length;d++)h.addFacet(a.facets[d])};h.addFieldConfig=function(a){h.fieldConfig.push(a);h.fields.push(a.name)};
h.enableAllFields=function(a){(_enableAllFields=a)?h.addQueryParam("fl","*"):h.removeQueryParam("fl");b()};h.setHighlightFields=function(a){addQueryParam("hl.fl",a.join(" "));highlightFields=a};h.removeQueryParam=function(a){delete _queryParams[a]};h.addQueryParam=function(a,d){var b=a+"="+d,f=!1,e;for(e in _queryParams)-1!=_queryParams[e].indexOf(a)&&(_queryParams[e]=b,f=!0);f||_queryParams.push(a+"="+d)};h.setSolrUrl=function(a){solrUrl=a};h.saveHistoryItem=function(){var d="",b=[];h.trigger("saveInQueryStr",
function(a,d,f){b.push({id:a,value:d,sortIndex:f})});for(var b=b.sort(f),e=0;e<b.length;e++)var g=b[e],d=d+"/"+g.id+"/"+g.value;a.load("!"+d)};h.search=function(){h.trigger("search");g(!0)};return h}(Serendip.Ajax,Serendip.History);var serendip=Serendip.Core;Serendip.Facets=function(c){function a(a,b,g){var b=decodeURIComponent(b),c=f[a],m=d[a];m||(m={},m.id=c.id,m.values=[]);if(g)m.values.push(b);else{g=[];for(c=0;c<m.values.length;c++)m.values[c]!=b&&g.push(m.values[c]);m.values=g}d[a]=m}var b={},d={},f=null,g=null;c.on("views.init",function(){g=c.facets;f=[];for(var e in g){var l=g[e];f[l.id]=l}c.on("views.init.done",function(){c.trigger("init.facets.core",b)});c.on("initFromQueryStr",function(a,b){d={};for(var f=0;f<g.length;f++){var e=g[f],c=e.id+
"";b[c]&&(c=b[c],facetQuery={},facetQuery.id=e.id,facetQuery.values=c.split(","),d[e.id]=facetQuery)}});c.on("saveInQueryStr",function(a){for(var b in d){var f=d[b].values;f&&0<f.length&&a(b,f.join(","),6)}});c.on("buildRequest",function(a){for(var b,e=g,c="",i=0;i<e.length;i++)c+=e[i].getQuery(),i<e.length-1&&(c+="&");a("&facet=true&"+c);e=[];for(b in d)c=f[b],i=d[b],0<i.values.length&&(c=c.getActiveQuery(i.values),e.push(c));b=0<e.length?"&"+e.join("&"):"";a("&"+b)});c.on("facet.remove",function(b){a(b.id,
b.value,!1)});c.on("facet.add",function(b){a(b.id,b.value,!0)})});b.getActiveFacetsQueriesMap=function(){return d};b.getActiveFacetsMap=function(){return f};return b}(serendip);Serendip.Facet=function(){var c={facetType:"text",name:null,activeHeader:null,header:null,minFacetsToDisplay:null,maxFacetsToDisplay:null,facets:[],parents:[],addSubFacet:function(a){c.facets.push(a);a.addParent(c)},addParent:function(a){c.parents.push(a)},getActiveQuery:function(a){var b="fq={!tag="+c.id+"}"+c.name,a=c.getActiveQueryValues(a);return b+(":("+a+")")},getActiveQueryValues:function(a){for(var b="",d=0;d<a.length;d++)var f=encodeURIComponent(a[d]),b=b+c.getActiveQueryValue(f);return b},
getActiveQueryValue:function(a){return'"'+a+'" '},getQuery:function(){return"facet.field={!ex="+c.id+"}"+c.name},parseActiveValue:function(a){var b="{!tag="+c.id+"}"+c.name+":(",d=a.substring(0,b.length);return b!=d?"":a.substring(b.length,a.length-1)},parseActiveFacetValue:function(a){var b=[],a=c.parseActiveValue(a);if(""!=a)for(var a=a.split(/\"\s/),d=0;d<a.length;d++){var f=a[d].replace(/\"/g,""),f=Serendip.Utils.trim(f);b.push(f)}return b},process:function(a){a=a.facet_counts.facet_fields[c.name];
return typeof("undefined"!=a)?a:[]},processActive:function(a){var b=encodeURIComponent(a),a=c.getFormattedValue(a);return c.processActiveField(b,a)},processActiveField:function(a,b){return{header:c.activeHeader,name:c.id,value:a,displayValue:b,isActive:"true"}},getFacetValue:function(a){return a},getFormattedValue:function(a){return a}};return c};Serendip.DateFacet=function(c){function a(a,b,g,e,c){var h=a[b+1],j={};j.from=a[b];var e=e.gap,m=1,k=1,i=0;"-"==e[0]&&(m=-1);e.match("YEARS")&&(i=e.substring(1,e.length-5),k=365);e.match("MONTHS")&&(i=e.substring(1,e.length-6),k=30);e.match("DAYS")&&(i=e.substring(1,e.length-4));e.match("YEAR")&&(i=e.substring(1,e.length-4),k=365);e.match("MONTH")&&(i=e.substring(1,e.length-5),k=30);e.match("DAY")&&(i=e.substring(1,e.length-3));var i=parseInt(i),n,e=j.from,m=i*m*k,k="";try{n=Serendip.Utils.convertISOFormatToDate(e),
n.setDate(n.getDate()+m),k=n.format("isoDateTime")+"Z"}catch(p){k="Could not parse date: "+e}n=k;j.to="asc"==c?b+2<a.length?a[b+2]:n:n;g.push(j);g.push(h)}var b=Serendip.Facet(c);b.facetType="date";b.dateStart=null;b.dateEnd=null;b.dateGap=null;b.dateFormat=null;b.sortDir="asc";b.getQuery=function(){var a="facet.date={!ex="+b.id+"}"+b.name,f="&f."+b.name+".facet.date",a=a+(f+".start="+encodeURIComponent(b.dateStart)),a=a+(f+".end="+encodeURIComponent(b.dateEnd));return a+=f+".gap="+encodeURIComponent(b.dateGap)};
b.getActiveQueryValue=function(a){return"["+a+"] "};b.getFacetValue=function(a){return a.from+" TO "+a.to};b.getFormattedValue=function(a){var f=Serendip.Utils.formatISODate(a.from,b.dateFormat),a=Serendip.Utils.formatISODate(a.to,b.dateFormat);return f+" - "+a};b.parseActiveFacetValue=function(a){a=b.parseActiveValue(a);return""!=a?Serendip.Utils.splitSolrMultiValue(a):[]};b.processActive=function(a){var f=a.split(" TO "),f=b.getFormattedValue({from:f[0],to:f[1]}),a=encodeURIComponent(a);return b.processActiveField(a,
f)};b.process=function(d){var d=d.facet_counts.facet_dates[b.name],f=[],c;for(c in d)"gap"!=c&&"end"!=c&&(f.push(c),f.push(d[c]));c=[];if("asc"==b.sortDir)for(var e=0;e<f.length;e+=2)a(f,e,c,d,"asc");else for(e=f.length-2;-1<e;e-=2)a(f,e,c,d,"desc");return c};return b};Serendip.RangeFacet=function(c){var a=Serendip.Facet(c);a.facetType="range";a.rangeStart=null;a.rangeEnd=null;a.rangeGap=null;a.getQuery=function(){var b="facet.range={!ex="+a.id+"}"+a.name,d="&f."+a.name+".facet.range",b=b+(d+".start="+encodeURIComponent(a.rangeStart)),b=b+(d+".end="+encodeURIComponent(a.rangeEnd));return b+=d+".gap="+encodeURIComponent(a.rangeGap)};a.getActiveQueryValue=function(a){return"["+a+"] "};a.getFacetValue=function(a){return a.from+" TO "+a.to};a.getFormattedValue=function(a){return a.from+
" - "+a.to};a.parseActiveFacetValue=function(b){b=a.parseActiveValue(b);return""!=b?Serendip.Utils.splitSolrMultiValue(b):[]};a.isFacetFieldActive=function(){return!1};a.processActive=function(b){var d=b.split(" TO "),d=a.getFormattedValue({from:d[0],to:d[1]}),b=encodeURIComponent(b);return a.processActiveField(b,d)};a.process=function(b){for(var d=b.facet_counts.facet_ranges,b=d[a.name].counts,d=d[a.name].gap,f=[],c=0;c<b.length;c+=2){var e=parseInt(b[c]),l=b[c+1],h={from:e};h.to=e+d-1;f.push(h);
f.push(l)}return f};return a};Serendip.QueryFacet=function(c){var a=Serendip.Facet(c);a.facetType="query";var b=[];a.addQuery=function(a){b.push(a)};a.getQuery=function(){for(var d="",f=b.length,c=0;c<f;c++)d+="facet.query={!ex="+a.id+" key="+a.id+"range["+c+"]}"+a.name+":"+b[c].query,c<f-1&&(d+="&");return d};a.getFacetValue=function(a){return a.value};a.getFormattedValue=function(a){return a.formattedValue};a.getActiveQueryValues=function(a){return a[a.length-1]};a.parseActiveFacetValue=function(b){var c=[],b=a.parseActiveValue(b);
""!=b&&c.push(b);return c};a.process=function(d){for(var d=d.facet_counts.facet_queries,c=[],g=0;g<b.length;g++){var e=b[g],l=d[a.id+"range["+g+"]"];c.push({formattedValue:e.header,value:e.query});c.push(l)}return c};a.processActive=function(d){var c=d,g;for(g in b){var e=b[g];e.query==d&&(c=e.header)}d=encodeURIComponent(d);return a.processActiveField(d,c)};return a};Serendip.FacetsRenderInactive=function(c){function a(a,b,c){c=b.getFacetValue(c);a=b.parseActiveFacetValue(a);for(b=0;b<a.length;b++)if(c==a[b])return!0;return!1}var b=null;c.on("init.facets.core",function(a){b=a});c.on("render",function(d){var f=[];if("undefined"!=typeof d.facet_counts){for(var g=c.facets,e=[],l=0;l<g.length;l++){var h=g[l],j;a:{j=h.parents;for(var m=b.getActiveFacetsQueriesMap(),k=0;k<j.length;k++){var i=j[k],n;for(n in m)if(n==i.id){j=!0;break a}}j=0==j.length?!0:!1}j&&e.push(h)}for(g=
0;g<e.length;g++){l=d;h=e[g];if(n=h.process(l)){j=n;n=[];m=[];for(k=0;k<j.length;k+=2){var i=j[k],p=j[k+1];if(0<p||-1==p)m.push(i),m.push(p)}j=m;m=j.length;for(k=0;k<m;k+=2){var q=j[k],i=j[k+1];if(""!=q){var s;b:{p=h;s=q;var r=l.responseHeader.params.fq;if(r)if(!Serendip.Utils.isArray(r)||1==r[0].length){if(a(r,p,s)){s=!0;break b}}else for(var t=0;t<r.length;t++)if(a(r[t],p,s)){s=!0;break b}s=!1}p=h;r=p.getFormattedValue(q);q=p.getFacetValue(q);q=encodeURIComponent(q);t=void 0;t=s?"":{name:p.id,value:q,
displayValue:r,countValue:i,countValueCls:"count"+i,isActive:"false"};i=t;""!=i&&n.push(i)}}l={facet:h,values:n}}else l="";""!=l&&f.push(l)}}d=[];for(e=0;e<f.length;e++){g=f[e];l=g.values;h=[];n=Math.min(g.facet.minFacetsToDisplay,l.length);for(j=0;j<n;j++)h.push(l[j]);d.push({facet:g.facet,values:h})}c.trigger("render.facets.inactive",f,d)});return{}}(serendip);Serendip.FacetsRenderActive=function(c){var a=null;c.on("init.facets.core",function(b){a=b});c.on("render",function(){var b=[],d=a.getActiveFacetsQueriesMap(),f=a.getActiveFacetsMap(),g;for(g in d){var e=d[g],l=f[g];if(0!=e.values.length)for(var h=0;h<e.values.length;h++){var j=l.processActive(e.values[h]);b.push(j)}}c.trigger("render.facets.active",b)});return{}}(serendip);
